"use strict";Object.defineProperty(exports,"__esModule",{value:true});Object.defineProperty(exports,"UserController",{enumerable:true,get:function(){return UserController}});const _UserQueries=require("../utils/queries/UserQueries");const _BaseController=require("./BaseController");const _types=require("../types");const _jsonwebtoken=_interop_require_default(require("jsonwebtoken"));function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _interop_require_default(obj){return obj&&obj.__esModule?obj:{default:obj}}class UserController extends _BaseController.BaseController{async signIn(req,res){try{const url=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${this.client_id}&redirect_uri=${this.redirect_uri}&response_type=code&scope=profile email`;return res.status(200).json({url})}catch(error){return res.status(500).json({message:error.message})}}async googleCallback(req,res){try{const{code}=req.query;if(!code){return res.status(400).json({message:"Invalid code"})}const tokenResponse=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.client_id,client_secret:this.client_secret,code:code,redirect_uri:this.redirect_uri,grant_type:"authorization_code"})});if(!tokenResponse.ok){const errorData=await tokenResponse.json();throw new Error(errorData.error||"Failed to obtain access token")}const{access_token}=await tokenResponse.json();const profileResponse=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${access_token}`}});if(!profileResponse.ok){const errorData=await profileResponse.json();throw new Error(errorData.error||"Failed to fetch user profile")}const{email}=await profileResponse.json();const results=await this.userQueries.execLogin(email);const values=this.getValues(results);const user=new _types.User(parseInt(values[0]),values[1]);const jwtToken=_jsonwebtoken.default.sign({user_id:user.user_id,user_email:user.user_email},process.env.JWT_SECRET,{expiresIn:"1d"});return res.status(200).json({access_token:jwtToken})}catch(error){return res.status(500).json({message:error.message})}}constructor(){super();_define_property(this,"client_id",void 0);_define_property(this,"client_secret",void 0);_define_property(this,"redirect_uri",void 0);_define_property(this,"userQueries",void 0);this.client_id=process.env.GOOGLE_CLIENT_ID;this.client_secret=process.env.GOOGLE_CLIENT_SECRET;this.redirect_uri=process.env.GOOGLE_REDIRECT_URI;this.userQueries=new _UserQueries.UserQueries}}